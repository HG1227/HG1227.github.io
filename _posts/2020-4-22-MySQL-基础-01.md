---
layout: post
title:  MySQL 基础 01
date:   2020-4-22
categories: MySQL
tags:  MySQL
---
* content
{:toc}






# 连接服务器

使用 [mysql](https://dev.mysql.com/doc/refman/8.0/en/mysql.html) 客户端工具连接 MySQL 服务器的命令行如下：

```sql
mysql [-h host_name] [-P port_num] [-u user_name] [-p] [-D db_name]
```

其中，*host_name*  表示服务器主机名，默认为本机；*port_num* 表示 MySQL 服务端口，默认为 3306；*user_name* 表示用户名，默认为当前操作系统用户；-p 提示输入密码；*db_name* 表示要连接的数据库。



mysql 中的 SQL 命令支持以`;`、`\g` 或者`\G`结束并发送到服务器。

```sql
mysql> select version();
+-----------+
| version() |
+-----------+
| 8.0.19    |
+-----------+
1 row in set (0.00 sec)

```

## 查看连接

使用`show processlist`命令可以查看所有连接到服务器的进程：

```sql
mysql> show processlist;
```

使用`kill pid`命令杀掉指定连接进程：

```sql
mysql> kill 23;
```

## 退出连接

使用`exit;`、`quit;`或者`\q`命令退出 mysql 客户端：

```sql
mysql> exit;
Bye

```

# 账户和权限

## 创建用户

使用`CREATE USER`语句创建一个用户：

```sql
CREATE USER [IF NOT EXISTS] user_name@host IDENTIFIED BY 'auth_string';
```

其中，*user_name* 表示用户名；*host* 表示允许用户从哪个主机连接 MySQL 服务器，如果省略（等价于 %）表示任何主机；IDENTIFIED BY 用于指定用户的密码。

```sql
mysql> create user tony identified by 'Pswd123!';
Query OK, 0 rows affected (0.14 sec)

```

## 查看用户

MySQL 中的用户信息存储在 mysql.user 系统表中。

使用 user() 或者 current_user() 函数查看当前用户：

```sql
mysql> select user();
+----------------+
| user()         |
+----------------+
| root@localhost |
+----------------+
1 row in set (0.00 sec)

```

## 修改密码

使用`ALTER USER`语句修改用户的密码：

```sql
mysql> alter user tony identified by 'Pswd123@';
Query OK, 0 rows affected (0.12 sec)

```

## 锁定/解锁用户

使用`ALTER USER`语句锁定或者解锁用户：

```sql
mysql> alter user tony account lock;
Query OK, 0 rows affected (0.10 sec)

mysql> alter user tony account unlock;
Query OK, 0 rows affected (0.10 sec)

```

其中，`account lock` 表示锁定；`account unlock` 表示解锁。

## 用户授权

MySQL 使用`GRANT`语句给用户授权：

```sql
GRANT priv_type [, priv_type] ...
   ON priv_level
   TO user_name@host；

```

其中，priv_type 表示权限，例如查询（SELECT）、执行（EXECUTE）、全部（ALL）权限等；priv_level 表示权限的级别，分为全局（*.*）、数据库（db.*）、表级（db.table）权限等。以下语句为用户 tony 授予 hrdb 数据库中 employees 表上的增删改查权限：

```sql
mysql> grant select,insert,update,delete 
    -> on hrdb.employees
    -> to tony;
Query OK, 0 rows affected (0.07 sec)

```

## 查看权限

使用`SHOW GRANTS [FOR user_name]`语句查看授予用户的权限和角色：

```sql
mysql> SHOW GRANTS FOR tony;
+--------------------------------------------------------------------------+
| Grants for tony@%                                                        |
+--------------------------------------------------------------------------+
| GRANT USAGE ON *.* TO `tony`@`%`                                         |
| GRANT SELECT, INSERT, UPDATE, DELETE ON `hrdb`.`employees` TO `tony`@`%` |
+--------------------------------------------------------------------------+
2 rows in set (0.00 sec)

```

如果省略 FOR user_name，返回当前用户的权限和角色。

## 撤销权限

撤销授予用户的权限和角色使用`REVOKE`语句：

```sql
REVOKE priv_type [, priv_type] ...
    ON priv_level
  FROM user_name@host；
```

其中的参数与`GRANT`语句相同。以下语句撤销用户 tony 对 employess 表的删除权限：

```sql
mysql> revoke delete 
    -> on hrdb.employees
    -> from tony;
Query OK, 0 rows affected (0.01 sec)
```







# 管理数据库

## 查看数据库

使用`show databases;`命令查看当前 MySQL 服务器中所有可用的数据库：

```sql
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| ds                 |
| hrdb               |
| information_schema |
| mydb               |
| mysql              |
| performance_schema |
| sys                |
| world_x            |
+--------------------+
8 rows in set (0.00 sec)

```

## 创建数据库

使用`CREATE DATABASE`语句创建一个新的数据库：

```sql
CREATE DATABASE [IF NOT EXISTS] db_name [CHARACTER SET charset_name]
```

其中，*db_name* 是数据库的名称；如果该数据库已经存在，将会返回错误；此时如果指定了 IF NOT EXISTS 选项，不会返回错误。

```sql
mysql> create database testdb;
Query OK, 1 row affected (0.15 sec)

mysql> create database testdb;
ERROR 1007 (HY000): Can't create database 'testdb'; database exists
mysql> create database if not exists testdb;
Query OK, 1 row affected, 1 warning (0.05 sec)

mysql> show warnings;
+-------+------+-------------------------------------------------+
| Level | Code | Message                                         |
+-------+------+-------------------------------------------------+
| Note  | 1007 | Can't create database 'testdb'; database exists |
+-------+------+-------------------------------------------------+
1 row in set (0.00 sec)

```

## 切换数据库

使用`USE db_name;`语句切换当前默认的数据库：

```sql
mysql> use testdb;
Database changed

```

## 删除数据库

使用`DROP DATABASE`语句删除一个数据库，该数据库中的所有对象以及与该数据库相关的数据文件也会被删除：

```sql
DROP DATABASE [IF EXISTS] db_name;
```

将 testdb 数据库和相关的数据文件删除：

```sql
mysql> drop database testdb;
Query OK, 0 rows affected (0.23 sec)
```

# 管理表

## 创建表

MySQL 使用`CREATE TABLE`语句创建表：

```sql
CREATE TABLE [IF NOT EXISTS] table_name(
   col1 data_type column_constraint,
   col2 data_type column_constraint,
   ...,
   table_constraints
) ENGINE=storage_engine;

```

其中，data_type 定义字段的数据类型，常用的数据类型包括：SMALLINT、INT、BIGINT、DECIMAL、CHAR、VARCHAR、TEXT、DATE、DATETIME 等。数据库约束包括主键约束（PRIMARY KEY）、外键约束（FOREIGN KEY）、唯一约束（UNIQUE）、非空约束（NOT NULL）、检查约束（CHECK）以及默认值（DEFAULT）。


## 查看所有表

使用`SHOW TABLES`语句查看当前数据库中的所有表：

```sql
mysql> show tables;
+------------------+
| Tables_in_testdb |
+------------------+
| departments      |
| employees        |
| jobs             |
+------------------+
3 rows in set (0.01 sec)

```

## 查看表结构

MySQL 提供了查看表结构的`DESCRIBE`语句：

```sql
mysql> desc employees;
```

## 增加字段

增加字段使用`ALTER TABLE ... ADD COLUMN`语句，以下命令为 employees 表增加一个字段 phone_number：

```sql
mysql> alter table employees add column phone_number varchar(20);
Query OK, 0 rows affected (0.07 sec)
Records: 0  Duplicates: 0  Warnings: 0
```

## 修改字段

修改字段使用`ALTER TABLE ... MODIFY`语句，以下命令为字段 phone_number 增加一个唯一约束：

```sql
mysql> alter table employees modify phone_number varchar(20) unique;
Query OK, 0 rows affected (0.09 sec)
Records: 0  Duplicates: 0  Warnings: 0
```

## 删除字段

删除字段使用`ALTER TABLE ... DROP COLUMN`语句：

```sql
mysql> alter table employees drop column phone_number;
Query OK, 0 rows affected (0.18 sec)
Records: 0  Duplicates: 0  Warnings: 0
```

## 删除表

要删除表可以使用`DROP TABLE`语句：

```sql
mysql> drop table if exists employees, departments, jobs;
Query OK, 0 rows affected (0.09 sec)
```

<img src="https://raw.githubusercontent.com/HG1227/image/master/img_tuchuang/20200427201842.png"/>

# 索引与约束

## 创建索引

MySQL 为主键和唯一约束自动创建相应的索引，我们也可以创建额外的索引。创建索引的命令如下：

```sql
CREATE [UNIQUE] INDEX index_name
ON table_name(col1 ASC, col2 DESC);
```

## 查看索引

查看表中的所以可以使用`SHOW INDEXES`语句：

```sql
mysql> show indexes from departments\G
```

## 修改索引

修改索引支持设置索引的可见性：

```sql
ALTER INDEX index VISIBLE | INVISIBLE; 
```

可见性是指对优化器而言，默认为可见（VISIBLE）；INVISIBLE 表示不可见。

## 删除索引

删除索引使用以下命令：

```sql
DROP INDEX index_name ON table_name;
```

## 增加约束

为表增加约束可以使用`ALTER TABLE`语句：

```sql
ALTER TABLE table_name ADD CONSTRAINT symbol PRIMARY KEY(col1,...);
ALTER TABLE table_name ADD CONSTRAINT symbol UNIQUE(col1,...);
ALTER TABLE table_name ADD CONSTRAINT symbol FOREIGN KEY (col1) REFERENCES other_table(col1);
ALTER TABLE table_name ADD CONSTRAINT symbol CHECK (expr);
ALTER TABLE table_name ALTER COLUMN col_name SET DEFAULT (expr); 
ALTER TABLE table_name MODIFY COLUMN col_name data_type NOT NULL;

```

## 删除约束

删除约束同样可以使用`ALTER TABLE`语句：

```sql
ALTER TABLE table_name DROP CHECK|CONSTRAINT symbol;
ALTER TABLE table_name ALTER COLUMN col_name DROP DEFAULT;
ALTER TABLE table_name MODIFY COLUMN col_name data_type NULL;

```

# 查询语句

## 单表查询

查询单个表中的字段：

```sql
SELECT col1, col2, ... FROM t; 
```

查询所有字段：

```sql
SELECT * FROM t;
```

排除查询结果中的重复数据：

```sql
SELECT DISTINCT col1, col2, ...
FROM t;
```

##  查询条件

使用`WHERE`指定查询条件：

```sql
SELECT col1, col2, ... 
FROM t
WHERE conditions;
```

常用的查询条件包括：=、!=、<>、<、<=、>、>=、BETWEEN、IN、EXISTS、LIKE、AND、OR、NOT、IS [NOT] NULL 等。

## 模糊匹配

使用`LIKE`运算符进行简单的字符串模式匹配：

```sql
expr LIKE pattern [ESCAPE escape_character]
```

其中，pattern 用于指定一个匹配模式，百分号（`%`）匹配任意多个字符，下划线（`_`）匹配任意单个字符；escape_character 指定转义字符

```sql
mysql> select first_name
    -> from employees
    -> where first_name like '%s_n';
+------------+
| first_name |
+------------+
| Harrison   |
| Jason      |
| Susan      |
+------------+
3 rows in set (0.01 sec)

```

## 排序操作

指定排序字段的方式如下：

```sql
SELECT col1, col2, ... 
FROM t 
ORDER BY col1 ASC, col2 DESC;
```

## 限定数量

限制返回结果的数量：

```sql
SELECT col1, col2, ... 
FROM t 
ORDER BY col1 ASC, col2 DESC
LIMIT offset, rows; 
```

## 分组操作

指定分组和过滤：

```sql
SELECT col1, col2, agg_func() 
FROM t
GROUP BY col1, col2 WITH ROLLUP 
HAVING conditions;
```

常用的聚合函数：AVG、COUNT、MIN、MAX、SUM 等。

## 多表连接

连接查询用于从多个表中查询关联数据：

```sql
SELECT t1.col1, t2.col1, ... 
FROM table1 AS t1
[INNER | LEFT | RIGHT | CROSS] JOIN t2 
ON conditions; 
```

## 子查询

子查询是指嵌套在其他查询语句中的查询：

```sql
SELECT t.col1, t.col2, ... 
FROM (SELECT ...) t ; 
```

EXISTS 与关联子查询：

```
SELECT t1.col1, t1.col2, ...
FROM t1
WHERE EXISTS ( SELECT 1
               FROM t2
               WHERE t2.col1 = t1.col1);
```

## 集合运算

集合运算包括并集、交集和差集：

```sql
SELECT col1, col2, ...
FROM t1
UNION [ALL] | INTERSECT | MINUS
SELECT c1, c2, …
FROM t2; 
```

UNION ALL 保留结果中的重复数据，其他运算符消除了重复结果。



<img src="https://raw.githubusercontent.com/HG1227/image/master/img_tuchuang/20200428084653.png"/>

# DML 语句

## 插入数据

插入数据使用`INSERT`语句：

```sql
INSERT INTO table(col1,col2,...)
VALUES (val1,val2,...);
```

一次插入多条记录：

```sql
INSERT INTO table(col1,col2,...)
VALUES (val11,val12,...), (val21,val22,...), (val31,val32,...);
```

插入查询语句的结果：

```sql
INSERT INTO table(col1,col2,...)
SELECT ...;
```

## 更新数据

更新数据使用`UPDATE`语句：

```sql
UPDATE table_name
SET col1 = val1, 
    col2 = val2, 
    ...
WHERE conditions;
```

`UPDATE`语句支持跨表更新：

```sql
UPDATE t1, t2,
[INNER JOIN | LEFT JOIN] t1 ON t1.col1 = t2.col1
SET t1.col2 = t2.col2,
    t2.c3 = expr
WHERE conditions;
```

## 删除数据

删除数据使用`DELETE`语句：

```sql
DELETE FROM table_name
WHERE conditions;
```

DELETE语句支持多表删除：

```sql
DELETE t1, t2
FROM t1
INNER JOIN t2 ON t1.col1 = t2.col1
WHERE conditions;

DELETE t1
FROM t1
LEFT JOIN t2 ON t1.col1 = t2.col1
WHERE t2.key IS NULL;
```

## 合并数据

合并语句同时执行了 INSERT 和 UPDATE 操作：

```sql
INSERT INTO table(col1,col2,...)
VALUES (val1,val2,...) 
ON DUPLICATE KEY UPDATE
    col1 = val1, 
    col2 = val2, 
    …;
```

与此类似的操作还有`REPLACE INTO`语句：

```sql
REPLACE INTO table_name(col1, col2, ...)
VALUES (val1,val2,...);
```



# 事务控制

数据库事务是一组相关的操作，要么全部成功，要么全部失败。

## 开始事务

`START TRANSACTION`语句用于开始一个事务：

```sql
START TRANSACTION;
```

`BEGIN`或者`BEGIN WORK`的作用也一样。

## 提交事务

提交事务的命令如下：

```sql
COMMIT;
```

## 回滚事务

回滚事务的命令如下：

```sql
ROLLBACK;
```

## 事务保存点

事务保存点可以用于回滚部分事务：

```sql
SAVEPOINT identifier;
ROLLBACK TO identifier;
RELEASE SAVEPOINT identifier;
```

# 视图

## 创建视图

使用以下命令创建视图：

```sql
CREATE [OR REPLACE] VIEW view_name
AS
  select-statement
  WITH CHECK OPTION;
```

WITH CHECK OPTION 选项可以阻止通过视图修改或者插入视图范围之外的基础表数据。

## 查看所有视图

`SHOW TABLES`语句支持查看视图：

```sql
SHOW FULL TABLES
WHERE table_type = 'VIEW';
```

## 查看视图定义

```sql
SHOW CREATE VIEW view_name;
```

## 重命名视图

重命名视图与重命名表类似：

```sql
RENAME TABLE view_name TO new_view;
```

## 删除视图

```sql
DROP VIEW [IF EXISTS] view_name;
```

# 存储过程/函数

## 创建存储过程/函数

创建存储过程使用`CREATE PROCEDURE`语句：

```sql
DELIMITER //
CREATE PROCEDURE GetEmployeeNameById(IN pn_empid INT)
BEGIN
    SELECT first_name, last_name FROM employees
    WHERE employee_id = pn_empid;
END //
DELIMITER ;
```

创建函数使用`CREATE FUNCTION`语句：

```sql
DELIMITER //
CREATE FUNCTION add_numbers(p1 INT, p2 INT)
RETURNS INT
DETERMINISTIC
BEGIN
    RETURN p1 + p2;
END //
DELIMITER ;
```

## 调用存储过程/函数

调用存储过程使用`CALL`语句：

```sql
mysql> CALL GetEmployeeNameById(100);
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| Steven     | King      |
+------------+-----------+
1 row in set (0.00 sec)

Query OK, 0 rows affected (0.00 sec)
```

存储函数可以像系统函数一样使用：

```sql
mysql> select add_numbers(1, 2);
+-------------------+
| add_numbers(1, 2) |
+-------------------+
|                 3 |
+-------------------+
1 row in set (0.00 sec)
```

## 删除存储过程/函数

删除存储过程/函数使用`DROP`语句：

```sql
mysql> drop procedure if exists GetEmployeeNameById;
Query OK, 0 rows affected (0.03 sec)

mysql> drop function if exists add_numbers;
Query OK, 0 rows affected (0.01 sec)
```

# 触发器

触发器是一个特殊的存储过程，当表中的数据被修改（INSERT、UPDATE、DELETE）时自动执行。

## 创建触发器

创建触发器使用`CREATE TRIGGER`语句：

```sql
CREATE TRIGGER trigger_name
{BEFORE | AFTER} {INSERT | UPDATE| DELETE }
ON table_name FOR EACH ROW
trigger_body;
```

对于 INSERT，可以使用NEW 变量；对于 UPDATE，可以使用 OLD 和 NEW 变量；对于 DELETE，可以使用 OLD 变量。

## 查看触发器

使用以下命令查看触发器：

```sql
SHOW TRIGGERS
[FROM | IN database_name]
[LIKE 'pattern' | WHERE condition];
```

## 删除触发器

删除触发器的语句如下：

```sql
DROP TRIGGER [IF EXISTS] trigger_name;
```

# 参考

1. <a href="https://blog.csdn.net/horses/article/details/104849500" blank ="">MySQL 常用命令 </a> 

